<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte Ejecutivo de Asesor</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
  font-family:'Segoe UI',Arial;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}

h2{
  text-align:center;
  color:#2c3e50;
}

select,button{
  padding:10px;
  margin:6px;
  border-radius:6px;
  border:none;
  font-size:14px;
}

button{
  background:#2c3e50;
  color:white;
  cursor:pointer;
}

#panel{
  display:none;
  margin-top:30px;
  background:white;
  padding:25px;
  border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

#textoResultado{
  margin-top:20px;
  font-size:14px;
  line-height:1.6;
}

canvas{
  margin-top:30px;
}
</style>
</head>
<body>

<h2>ðŸ“Š Reporte Ejecutivo por Asesor</h2>

<div style="text-align:center;">
<select id="asesorSelect"></select>
<button onclick="generar()">Generar Evidencia</button>
<button onclick="exportarPDF()">Exportar PDF</button>
</div>

<div id="panel">
<h3 id="tituloAsesor"></h3>
<div id="textoResultado"></div>
<canvas id="grafico" height="100"></canvas>
</div>

<script>

const url="https://docs.google.com/spreadsheets/d/e/2PACX-1vTv__z4dmUZOol3wAk_xfvxVHrJHFuaP3dKX8M9S-j6dd3WjUz0iCpxGnIOzpq2s1oOKPWGf5q45Yox/pub?output=csv";

fetch(url)
.then(r=>r.text())
.then(csv=>{

function parseCSV(text){
  const rows=[],row=[];
  let val="",inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(c=='"'&&inQuotes&&n=='"'){val+='"';i++;}
    else if(c=='"'){inQuotes=!inQuotes;}
    else if(c==','&&!inQuotes){row.push(val);val="";}
    else if((c=='\n'||c=='\r')&&!inQuotes){
      if(val||row.length){row.push(val);rows.push([...row]);}
      row.length=0;val="";
    }
    else val+=c;
  }
  return rows;
}

const filas=parseCSV(csv);
const encabezados=filas[0];
const datos=filas.slice(1);

const IDX={
  RAC:encabezados.indexOf("RAC"),
  SEMANA:encabezados.indexOf("SEMANA")
};

const indicadores=encabezados.filter(h=>h.includes("%"));

const asesores=[...new Set(datos.map(f=>f[IDX.RAC]))];

const select=document.getElementById("asesorSelect");
asesores.forEach(a=>{
  const o=document.createElement("option");
  o.value=o.textContent=a;
  select.appendChild(o);
});

let chart;

window.generar=function(){

const asesor=select.value;

const filasA=datos.filter(f=>f[IDX.RAC]===asesor && f[IDX.SEMANA]?.includes("Total Semana"));

if(filasA.length<2){
  alert("No hay suficientes semanas");
  return;
}

const actual=filasA[filasA.length-1];
const anterior=filasA[filasA.length-2];

let texto=`El asesor <b>${asesor}</b> presentÃ³:<br><br>`;

let datasets=[];

indicadores.forEach(ind=>{
  const col=encabezados.indexOf(ind);
  const valAct=parseFloat(actual[col]);
  const valAnt=parseFloat(anterior[col]);

  if(isNaN(valAct)||isNaN(valAnt)) return;

  let diff=valAct-valAnt;
  let estado="Sin cambio";

  if(diff>0) estado="Mejora";
  if(diff<0) estado="Desmejora";

  texto+=`${ind}: ${estado} de ${Math.abs(diff).toFixed(2)}%<br>`;

  datasets.push({
    label:ind,
    data:filasA.map(f=>parseFloat(f[col])),
    borderWidth:2,
    tension:0.3,
    fill:false
  });
});

document.getElementById("tituloAsesor").innerHTML="Evidencia Comparativa Semanal";
document.getElementById("textoResultado").innerHTML=texto;
document.getElementById("panel").style.display="block";

if(chart) chart.destroy();

chart=new Chart(document.getElementById("grafico"),{
  type:"line",
  data:{
    labels:filasA.map(f=>f[IDX.SEMANA]),
    datasets:datasets
  },
  options:{
    responsive:true,
    plugins:{
      legend:{position:"bottom"}
    }
  }
});

}

window.exportarPDF=function(){
  html2pdf().from(document.getElementById("panel")).save("Evidencia_Asesor.pdf");
}

});
</script>
</body>
</html>

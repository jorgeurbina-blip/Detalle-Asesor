<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Inteligente PRO</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
  font-family:'Segoe UI',Arial;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}
h2{text-align:center;color:#2c3e50;}
select,button,input{
  padding:8px;
  margin:6px;
  border-radius:6px;
  border:1px solid #ccc;
}
button{
  background:#2c3e50;
  color:white;
  cursor:pointer;
}

.kpi-box{
  flex:1;
  padding:12px;
  border-radius:8px;
  text-align:center;
  font-weight:bold;
}

.kpi-verde{background:#d4edda;color:#155724;}
.kpi-amarillo{background:#fff3cd;color:#856404;}
.kpi-rojo{background:#f8d7da;color:#721c24;}

#panelAnalisis{
  display:none;
  margin-top:30px;
  background:white;
  padding:20px;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
}

.tabla-ranking{
  margin-top:20px;
  border-collapse:collapse;
  width:100%;
}
.tabla-ranking th{
  background:#2c3e50;
  color:white;
  padding:8px;
}
.tabla-ranking td{
  padding:6px;
  text-align:center;
  border-bottom:1px solid #eee;
}
</style>
</head>
<body>

<h2>游늵 Dashboard Inteligente PRO</h2>

<div style="text-align:center;">
<select id="asesorSelect"></select>
<button onclick="generarAnalisis()">Generar An치lisis</button>
<button onclick="exportarPDF()">Exportar PDF</button>
<button onclick="enviarCorreo()">Enviar por Correo</button>
</div>

<div id="panelAnalisis">
<div id="rankingContainer"></div>
<div id="kpisComparativos" style="display:flex;gap:10px;flex-wrap:wrap;"></div>
<canvas id="graficoAnalisis" height="100"></canvas>
<h3>Conclusi칩n Ejecutiva</h3>
<div id="textoAnalisis"></div>
<h3>Detalle de Indicadores</h3>
<div id="detalleIndicadores"></div>
</div>

<script>

const url="TU_LINK_CSV_AQUI";

fetch(url)
.then(r=>r.text())
.then(csv=>{

function parseCSV(text){
  const rows=[],row=[];
  let val="",inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(c=='"'&&inQuotes&&n=='"'){val+='"';i++;}
    else if(c=='"'){inQuotes=!inQuotes;}
    else if(c==','&&!inQuotes){row.push(val);val="";}
    else if((c=='\n'||c=='\r')&&!inQuotes){
      if(val||row.length){row.push(val);rows.push([...row]);}
      row.length=0;val="";
    }
    else val+=c;
  }
  return rows;
}

const filas=parseCSV(csv);
const encabezados=filas[0];
const datos=filas.slice(1);

const IDX={
  RAC:encabezados.indexOf("RAC"),
  SEMANA:encabezados.indexOf("SEMANA"),
  MES:encabezados.indexOf("MES")
};

const indicadores=encabezados.filter(h=>h.includes("%"));

const asesores=[...new Set(datos.map(f=>f[IDX.RAC]))];
const select=document.getElementById("asesorSelect");
asesores.forEach(a=>{
  const o=document.createElement("option");
  o.value=o.textContent=a;
  select.appendChild(o);
});

let chart;

function evaluar(a,b,menor=false){
  if(isNaN(a)||isNaN(b)) return {estado:"Sin datos",clase:"kpi-amarillo",dif:0};
  let diff=a-b;
  if(menor) diff=b-a;
  if(diff>0) return {estado:"Mejora",clase:"kpi-verde",dif:Math.abs(diff).toFixed(2)};
  if(diff<0) return {estado:"Desmejora",clase:"kpi-rojo",dif:Math.abs(diff).toFixed(2)};
  return {estado:"Sin cambio",clase:"kpi-amarillo",dif:0};
}

function calcularScore(fila){
  let total=0,count=0;
  indicadores.forEach(ind=>{
    const val=parseFloat(fila[encabezados.indexOf(ind)]);
    if(!isNaN(val)){ total+=val; count++; }
  });
  return count? (total/count).toFixed(2):0;
}

function generarRanking(){
  const ranking=asesores.map(a=>{
    const filasA=datos.filter(f=>f[IDX.RAC]===a && f[IDX.SEMANA]?.includes("Total Semana"));
    const ultima=filasA[filasA.length-1];
    return {
      asesor:a,
      score:ultima?parseFloat(calcularScore(ultima)):0
    };
  }).sort((a,b)=>b.score-a.score);

  let html=`<h3>游끥 Ranking Global</h3><table class="tabla-ranking"><tr><th>#</th><th>Asesor</th><th>Score</th></tr>`;
  ranking.forEach((r,i)=>{
    html+=`<tr><td>${i+1}</td><td>${r.asesor}</td><td>${r.score}</td></tr>`;
  });
  html+="</table>";
  document.getElementById("rankingContainer").innerHTML=html;
}

window.generarAnalisis=function(){

const asesor=select.value;
const filasA=datos.filter(f=>f[IDX.RAC]===asesor && f[IDX.SEMANA]?.includes("Total Semana"));

if(filasA.length<2){alert("No hay suficientes semanas");return;}

const actual=filasA[filasA.length-1];
const anterior=filasA[filasA.length-2];

document.getElementById("panelAnalisis").style.display="block";

generarRanking();

let htmlKPI="";
let texto="<ul>";
let datasets=[];

indicadores.forEach(ind=>{
  const col=encabezados.indexOf(ind);
  const menor=ind.toLowerCase().includes("rein");
  const ev=evaluar(parseFloat(actual[col]),parseFloat(anterior[col]),menor);
  htmlKPI+=`<div class="kpi-box ${ev.clase}">${ind}<br>${ev.estado} (${ev.dif}%)</div>`;
  texto+=`<li>${ind}: ${ev.estado} de ${ev.dif}%</li>`;
  datasets.push({
    label:ind,
    data:filasA.map(f=>parseFloat(f[col])),
    borderWidth:2,
    tension:0.3
  });
});

texto+="</ul>";

document.getElementById("kpisComparativos").innerHTML=htmlKPI;
document.getElementById("textoAnalisis").innerHTML=`El asesor <b>${asesor}</b> present칩:${texto}`;

document.getElementById("detalleIndicadores").innerHTML=`
Score Global: <b>${calcularScore(actual)}</b>
<br>Comparaci칩n Mensual autom치tica incluida en score
`;

if(chart) chart.destroy();
chart=new Chart(document.getElementById("graficoAnalisis"),{
  type:"line",
  data:{
    labels:filasA.map(f=>f[IDX.SEMANA]),
    datasets:datasets
  }
});

}

window.exportarPDF=function(){
  html2pdf().from(document.getElementById("panelAnalisis")).save("Reporte_Asesor_PRO.pdf");
}

window.enviarCorreo=function(){
  const asesor=select.value;
  const body=document.getElementById("textoAnalisis").innerText;
  window.location.href=`mailto:?subject=Reporte ${asesor}&body=${encodeURIComponent(body)}`;
}

});
</script>
</body>
</html>

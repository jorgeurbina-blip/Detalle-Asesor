<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Inteligente de Indicadores</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
  font-family: 'Segoe UI', Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}
h2{text-align:center;color:#2c3e50;}
input,select,button{
  padding:8px;
  margin:6px;
  border-radius:6px;
  border:1px solid #ccc;
}
button{cursor:pointer;background:#34495e;color:white;}
.table-container{
  overflow:auto;
  max-height:60vh;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  background:white;
}
table{
  border-collapse:collapse;
  width:100%;
  font-size:12px;
}
th{
  background:#34495e;
  color:white;
  padding:8px;
  position:sticky;
  top:0;
  cursor:pointer;
}
td{
  padding:6px;
  text-align:center;
  border-bottom:1px solid #eee;
}
tr:nth-child(even){background:#f9fbfd;}
tr:hover{background:#e8f4ff;}

.kpi-verde{background:#d4edda;color:#155724;font-weight:bold;}
.kpi-amarillo{background:#fff3cd;color:#856404;font-weight:bold;}
.kpi-rojo{background:#f8d7da;color:#721c24;font-weight:bold;}

.barra-kpi{
  height:8px;
  border-radius:4px;
  margin-bottom:2px;
}

#panelAnalisis{
  margin-top:30px;
  background:white;
  padding:20px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  display:none;
}
.kpi-box{
  flex:1;
  padding:10px;
  border-radius:8px;
  text-align:center;
}
</style>
</head>
<body>

<h2>游늵 Dashboard Inteligente de Indicadores</h2>

<div style="text-align:center;">
  <input type="text" id="filtro" placeholder="Buscar...">
  <select id="vista">
    <option value="dia">Vista Diaria</option>
    <option value="semana">Vista Semanal</option>
    <option value="mes">Vista Mensual</option>
  </select>
  <select id="mesFiltro"><option value="">Todos los meses</option></select>
</div>

<div class="table-container">
  <table>
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<hr>

<h2>游늳 An치lisis Autom치tico por Asesor</h2>

<div style="text-align:center;">
  <select id="asesorSelect"></select>
  <button onclick="generarAnalisis()">Generar An치lisis</button>
  <button onclick="exportarPDF()">Exportar PDF</button>
</div>

<div id="panelAnalisis">
  <div id="kpisComparativos" style="display:flex;gap:10px;flex-wrap:wrap;"></div>
  <canvas id="graficoAnalisis" height="100"></canvas>
  <h3>Conclusi칩n Ejecutiva</h3>
  <div id="textoAnalisis"></div>
</div>

<script>

const url="https://docs.google.com/spreadsheets/d/e/2PACX-1vTv__z4dmUZOol3wAk_xfvxVHrJHFuaP3dKX8M9S-j6dd3WjUz0iCpxGnIOzpq2s1oOKPWGf5q45Yox/pub?output=csv";

function parseCSV(text){
  const rows=[], r=[], v="";
  let row=[], val="", inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c === '"' && inQuotes && n === '"'){val+='"'; i++;}
    else if(c === '"'){inQuotes=!inQuotes;}
    else if(c === ',' && !inQuotes){row.push(val); val="";}
    else if((c=='\n'||c=='\r')&&!inQuotes){if(val||row.length){row.push(val);rows.push(row);} row=[];val="";}
    else val+=c;
  }
  if(val||row.length){row.push(val);rows.push(row);}
  return rows;
}

fetch(url)
.then(r=>r.text())
.then(csv=>{

const filas=parseCSV(csv);
const encabezados=filas[0];
const datos=filas.slice(1);

const IDX={
  RAC:encabezados.indexOf("RAC"),
  DIA:encabezados.indexOf("DIA"),
  SEMANA:encabezados.indexOf("SEMANA"),
  MES:encabezados.indexOf("MES")
};

const thead=document.querySelector("thead");
const tbody=document.querySelector("tbody");

thead.innerHTML="<tr>"+encabezados.map(h=>`<th>${h}</th>`).join("")+"</tr>";

const reglasKPI={"% FCR 1dia":90,"% Rein.":5,"% VS Atendidas":90};
const invertidos=["% Rein."];

function claseKPI(h,v){
  if(!v.includes("%")) return "";
  const n=parseFloat(v);
  if(isNaN(n)) return "";
  const meta=reglasKPI[h]??85;
  if(invertidos.includes(h)){
    if(n<=meta) return "kpi-verde";
    if(n<=meta+5) return "kpi-amarillo";
    return "kpi-rojo";
  }
  if(n>=meta) return "kpi-verde";
  if(n>=meta-10) return "kpi-amarillo";
  return "kpi-rojo";
}

function render(data){
  tbody.innerHTML="";
  data.forEach(f=>{
    const tr=document.createElement("tr");
    f.forEach((c,i)=>{
      const td=document.createElement("td");
      td.className=claseKPI(encabezados[i],c);
      td.textContent=c;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

render(datos);

// ================= ANALISIS =================

const asesores=[...new Set(datos.map(f=>f[IDX.RAC]))];
const select=document.getElementById("asesorSelect");
asesores.forEach(a=>{
  const o=document.createElement("option");
  o.value=o.textContent=a;
  select.appendChild(o);
});

let chart;

function evaluar(actual,anterior,menorMejor=false){
  if(isNaN(actual)||isNaN(anterior)) return {estado:"Sin datos",clase:"kpi-amarillo",dif:0};
  let diff=actual-anterior;
  if(menorMejor) diff=anterior-actual;
  if(diff>0) return {estado:"Mejora",clase:"kpi-verde",dif:Math.abs(diff).toFixed(2)};
  if(diff<0) return {estado:"Desmejora",clase:"kpi-rojo",dif:Math.abs(diff).toFixed(2)};
  return {estado:"Sin cambio",clase:"kpi-amarillo",dif:0};
}

window.generarAnalisis=function(){

  const asesor=select.value;
  const filasAsesor=datos.filter(f=>f[IDX.RAC]===asesor && f[IDX.SEMANA]?.includes("Total Semana"));

  if(filasAsesor.length<2){alert("No hay suficientes semanas");return;}

  const actual=filasAsesor[filasAsesor.length-1];
  const anterior=filasAsesor[filasAsesor.length-2];

  const colReinc=encabezados.indexOf("% Rein.");
  const colFCR=encabezados.indexOf("% FCR 1dia");
  const colProd=encabezados.indexOf("% VS Atendidas");

  const eReinc=evaluar(parseFloat(actual[colReinc]),parseFloat(anterior[colReinc]),true);
  const eFCR=evaluar(parseFloat(actual[colFCR]),parseFloat(anterior[colFCR]));
  const eProd=evaluar(parseFloat(actual[colProd]),parseFloat(anterior[colProd]));

  document.getElementById("panelAnalisis").style.display="block";

  document.getElementById("kpisComparativos").innerHTML=`
    <div class="kpi-box ${eReinc.clase}">Reincidencia<br>${eReinc.estado} (${eReinc.dif}%)</div>
    <div class="kpi-box ${eFCR.clase}">FCR 1 D칤a<br>${eFCR.estado} (${eFCR.dif}%)</div>
    <div class="kpi-box ${eProd.clase}">Productividad<br>${eProd.estado} (${eProd.dif}%)</div>
  `;

  document.getElementById("textoAnalisis").innerHTML=`
  El asesor <b>${asesor}</b> present칩:
  <ul>
  <li>Reincidencia: ${eReinc.estado} de ${eReinc.dif}%</li>
  <li>FCR 1 D칤a: ${eFCR.estado} de ${eFCR.dif}%</li>
  <li>Productividad: ${eProd.estado} de ${eProd.dif}%</li>
  </ul>
  `;

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("graficoAnalisis"),{
    type:"line",
    data:{
      labels:filasAsesor.map(f=>f[IDX.SEMANA]),
      datasets:[{
        label:"Reincidencia %",
        data:filasAsesor.map(f=>parseFloat(f[colReinc])),
        borderWidth:2,
        tension:0.3
      }]
    }
  });
}

window.exportarPDF=function(){
  html2pdf().from(document.getElementById("panelAnalisis")).save("Reporte_Asesor.pdf");
}

});

</script>
</body>
</html>
